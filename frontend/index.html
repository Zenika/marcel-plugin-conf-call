<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <script src="https://simplewebrtc.com/latest-v2.js"></script>
  <script src="./marcel.js"></script>
</head>

<body>
  <div id="container">
    <div id="remotesVideos"></div>
    <div id="header">
      <button id="microButton" class="button secondary">
        <i class="material-icons">mic</i>
      </button>
      <button id="phoneButton" class="button">
        <i class="material-icons">phone</i>
      </button>
      <button id="webcamButton" class="button secondary">
        <i class="material-icons">videocam</i>
      </button>
      <video id="localVideo"></video>
    </div>
  </div>

  <script>
    class ConfCallPlugin extends Marcel.Plugin {
      constructor() {
        super()

        this.localVideo = document.getElementById('localVideo')
        this.remotesVideos = document.getElementById('remotesVideos')
        this.phoneButton = document.getElementById('phoneButton')
        this.microButton = document.getElementById('microButton')
        this.webcamButton = document.getElementById('webcamButton')
        this.phoneButton.addEventListener('click', () => this.phoneButtonClicked())
        this.microButton.addEventListener('click', () => this.microButtonClicked())
        this.webcamButton.addEventListener('click', () => this.webcamButtonClicked())
      }

      propsDidChange(prevProps) {
        if (!this.props.signalURL) console.error("Conf-Call : Missing signalURL prop")
        else if (!prevProps.signalURL) this.createWebtrcClient()
        else if (this.props.signalURL !== prevProps.signalURL) location.reload()
        else if (!this.props.channel) console.error("Conf-Call : Missing channel prop")
        else if (this.props.channel !== prevProps.channel && this.isInRoom) this.changeChannel()
      }

      changeChannel() {
        this.webrtcClient.leaveRoom()
        this.webrtcClient.joinRoom(this.props.channel)
      }

      leaveRoom() {
        this.webrtcClient.leaveRoom()
        this.webrtcClient.stopLocalVideo()
        this.localVideo.style.visibility = 'hidden'
      }

      joinRoom() {
        this.webrtcClient.startLocalVideo()
        this.phoneButton.disabled = true
      }

      muteMicro() {
        this.microButton.classList.add('muted')
        this.microButton.getElementsByTagName('i')[0].innerHTML = 'mic_off'
        this.webrtcClient.mute()
      }

      pauseWebcam() {
        this.webcamButton.classList.add('muted')
        this.webcamButton.getElementsByTagName('i')[0].innerHTML = 'videocam_off'
        this.webrtcClient.pauseVideo()
      }

      unmuteMicro() {
        this.microButton.classList.remove('muted')
        this.microButton.getElementsByTagName('i')[0].innerHTML = 'mic'
        this.webrtcClient.unmute()
      }

      resumeWebcam() {
        this.webcamButton.classList.remove('muted')
        this.webcamButton.getElementsByTagName('i')[0].innerHTML = 'videocam'
        this.webrtcClient.resumeVideo()
      }

      phoneButtonClicked() {
        if (this.phoneButton.classList.contains('close')) this.leaveRoom()
        else this.joinRoom()
      }

      microButtonClicked() {
        if (this.microButton.classList.contains('muted')) this.unmuteMicro()
        else this.muteMicro()
      }

      webcamButtonClicked() {
        if (this.webcamButton.classList.contains('muted')) this.resumeWebcam()
        else this.pauseWebcam()
      }

      createWebtrcClient() {
        const { signalURL, channel } = this.props

        this.webrtcClient = new SimpleWebRTC({
          localVideoEl: 'localVideo',
          remoteVideosEl: 'remotesVideos',
          url: signalURL,
        })

        this.webrtcClient.on('readyToCall', () => {
          this.webrtcClient.joinRoom(this.props.channel)
          this.localVideo.style.visibility = 'visible'
        })

        this.webrtcClient.on('joinedRoom', () => {
          this.phoneButton.classList.add('close')
          this.phoneButton.disabled = false
          this.isInRoom = true
        })

        this.webrtcClient.on('leftRoom', () => {
          this.phoneButton.classList.remove('close')
          this.isInRoom = false
        })
      }
    }

    const instance = new ConfCallPlugin()
  </script>
</body>

</html>
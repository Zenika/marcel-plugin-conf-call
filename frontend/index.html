<!DOCTYPE html>
<html>

<head>
  <link href="https://use.fontawesome.com/releases/v5.0.4/css/all.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <script src="https://simplewebrtc.com/latest-v2.js"></script>
  <script src="./marcel.js"></script>
</head>

<body>
  <div id="container">
    <div id="header">
      <video height="300" id="localVideo"></video>
      <button id="phoneButton">
        <i class="fas fa-phone-square"></i>
      </button>
    </div>
    <div id="remotesVideos"></div>
  </div>

  <script>
    class ConfCallPlugin extends Marcel.Plugin {
      constructor() {
        super({
          defaultProps: {
            signalURL: 'http://192.168.1.27:8888',
            channel: 'test'
          }
        })

        this.localVideo = document.getElementById('localVideo')
        this.phoneButton = document.getElementById('phoneButton')
        this.phoneButton.addEventListener('click', () => this.phoneButtonClicked())
      }

      propsDidChange(prevProps) {
        if (!prevProps.signalURL) this.createWebtrcClient()
        else if (this.props.signalURL !== prevProps.signalURL) location.reload()
        else if (this.props.channel !== prevProps.channel && this.isInRoom) this.changeChannel()
      }

      changeChannel() {
        this.webrtcClient.leaveRoom()
        this.webrtcClient.joinRoom(this.props.channel)
      }

      leaveRoom() {
        this.webrtcClient.leaveRoom()
        this.webrtcClient.stopLocalVideo()
        this.localVideo.style.visibility = 'hidden'
      }

      joinRoom() {
        this.webrtcClient.startLocalVideo()
        this.phoneButton.disabled = true
      }

      phoneButtonClicked() {
        if (this.phoneButton.classList.contains('close')) this.leaveRoom()
        else this.joinRoom()
      }

      createWebtrcClient() {
        const { signalURL, channel } = this.props

        this.webrtcClient = new SimpleWebRTC({
          localVideoEl: 'localVideo',
          remoteVideosEl: 'remotesVideos',
          url: signalURL,
        })

        this.webrtcClient.on('readyToCall', () => {
          this.webrtcClient.joinRoom(this.props.channel)
          this.localVideo.style.visibility = 'visible'
        })

        this.webrtcClient.on('joinedRoom', () => {
          this.phoneButton.classList.add('close')
          this.phoneButton.disabled = false
          this.isInRoom = true
        })

        this.webrtcClient.on('leftRoom', () => {
          this.phoneButton.classList.remove('close')
          this.isInRoom = false
        })
      }
    }


    const instance = new ConfCallPlugin()
    instance.createWebtrcClient()
  </script>
</body>

</html>